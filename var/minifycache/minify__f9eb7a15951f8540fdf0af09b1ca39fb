if(!window.Flex){alert('Flex library not loaded');}else{Flex.Uploader=Class.create();Flex.Uploader.prototype={flex:null,uploader:null,filters:null,containerId:null,flexContainerId:null,container:null,files:null,fileRowTemplate:null,fileProgressTemplate:null,templatesPattern:/(^|.|\r|\n)(\{\{(.*?)\}\})/,onFilesComplete:false,onFileProgress:true,onFileRemove:false,onContainerHideBefore:null,initialize:function(containerId,uploaderSrc,config){this.containerId=containerId;this.container=$(containerId);this.container.controller=this;this.config=config;this.flexContainerId=this.containerId+'-flash';Element.insert(this.containerId,{'before':'<div id="'+this.flexContainerId+'" class="flex" style="position:relative;float:right;"></div>'});flexWidth=230;if(this.config.width){flexWidth=this.config.width;}
this.flex=new Flex.Object({left:100,top:300,width:flexWidth,height:20,src:uploaderSrc,wmode:'transparent'});this.fileRowTemplate=new Template(this.getInnerElement('template').innerHTML,this.templatesPattern);this.fileProgressTemplate=new Template(this.getInnerElement('template-progress').innerHTML,this.templatesPattern);this.flex.onBridgeInit=this.handleBridgeInit.bind(this);if(this.flex.detectFlashVersion(9,0,28)){this.flex.apply(this.flexContainerId);}else{this.getInnerElement('install-flash').show();}
this.onContainerHideBefore=this.handleContainerHideBefore.bind(this);},getInnerElement:function(elementName){return $(this.containerId+'-'+elementName);},getFileId:function(file){var id;if(typeof file=='object'){id=file.id;}else{id=file;}
return this.containerId+'-file-'+id;},getDeleteButton:function(file){return $(this.getFileId(file)+'-delete');},handleBridgeInit:function(){this.uploader=this.flex.getBridge().getUpload();if(this.config.filters){$H(this.config.filters).each(function(pair){this.uploader.addTypeFilter(pair.key,pair.value.label,pair.value.files);}.bind(this));delete(this.config.filters);this.uploader.setUseTypeFilter(true);}
this.uploader.setConfig(this.config);this.uploader.addEventListener('select',this.handleSelect.bind(this));this.uploader.addEventListener('complete',this.handleComplete.bind(this));this.uploader.addEventListener('progress',this.handleProgress.bind(this));this.uploader.addEventListener('error',this.handleError.bind(this));this.uploader.addEventListener('removeall',this.handleRemoveAll.bind(this));},browse:function(){this.uploader.browse();},upload:function(){this.uploader.upload();this.files=this.uploader.getFilesInfo();this.updateFiles();},removeFile:function(id){this.uploader.removeFile(id);$(this.getFileId(id)).remove();if(this.onFileRemove){this.onFileRemove(id);}
this.files=this.uploader.getFilesInfo();this.updateFiles();},removeAllFiles:function(){this.files.each(function(file){this.removeFile(file.id);}.bind(this));this.files=this.uploader.getFilesInfo();this.updateFiles();},handleSelect:function(event){this.files=event.getData().files;this.checkFileSize();this.updateFiles();this.getInnerElement('upload').show();if(this.onFileSelect){this.onFileSelect();}},handleProgress:function(event){var file=event.getData().file;this.updateFile(file);if(this.onFileProgress){this.onFileProgress(file);}},handleError:function(event){this.updateFile(event.getData().file);},handleComplete:function(event){this.files=event.getData().files;this.updateFiles();if(this.onFilesComplete){this.onFilesComplete(this.files);}},handleRemoveAll:function(event){this.files.each(function(file){$(this.getFileId(file.id)).remove();}.bind(this));if(this.onFileRemoveAll){this.onFileRemoveAll();}
this.files=this.uploader.getFilesInfo();this.updateFiles();},handleRemove:function(event){this.files=this.uploader.getFilesInfo();this.updateFiles();},updateFiles:function(){this.files.each(function(file){this.updateFile(file);}.bind(this));},updateFile:function(file){if(!$(this.getFileId(file))){if(this.config.replace_browse_with_remove){$(this.containerId+'-new').show();$(this.containerId+'-new').innerHTML=this.fileRowTemplate.evaluate(this.getFileVars(file));$(this.containerId+'-old').hide();this.flex.getBridge().hideBrowseButton();}else{Element.insert(this.container,{bottom:this.fileRowTemplate.evaluate(this.getFileVars(file))});}}
if(file.status=='full_complete'&&file.response.isJSON()){var response=file.response.evalJSON();if(typeof response=='object'){if(typeof response.cookie=='object'){var date=new Date();date.setTime(date.getTime()+(parseInt(response.cookie.lifetime)*1000));document.cookie=escape(response.cookie.name)+"="
+escape(response.cookie.value)
+"; expires="+date.toGMTString()
+(response.cookie.path.blank()?"":"; path="+response.cookie.path)
+(response.cookie.domain.blank()?"":"; domain="+response.cookie.domain);}
if(typeof response.error!='undefined'&&response.error!=0){file.status='error';file.errorText=response.error;}}}
if(file.status=='full_complete'&&!file.response.isJSON()){file.status='error';}
var progress=$(this.getFileId(file)).getElementsByClassName('progress-text')[0];if((file.status=='progress')||(file.status=='complete')){$(this.getFileId(file)).addClassName('progress');$(this.getFileId(file)).removeClassName('new');$(this.getFileId(file)).removeClassName('error');if(file.progress&&file.progress.total){progress.update(this.fileProgressTemplate.evaluate(this.getFileProgressVars(file)));}else{progress.update('');}
if(!this.config.replace_browse_with_remove){this.getDeleteButton(file).hide();}}else if(file.status=='error'){$(this.getFileId(file)).addClassName('error');$(this.getFileId(file)).removeClassName('progress');$(this.getFileId(file)).removeClassName('new');var errorText=file.errorText?file.errorText:this.errorText(file);if(this.config.replace_browse_with_remove){this.flex.getBridge().hideBrowseButton();}else{this.getDeleteButton(file).show();}
progress.update(errorText);}else if(file.status=='full_complete'){$(this.getFileId(file)).addClassName('complete');$(this.getFileId(file)).removeClassName('progress');$(this.getFileId(file)).removeClassName('error');if(this.config.replace_browse_with_remove){this.flex.getBridge().hideRemoveButton();}
progress.update(this.translate('Complete'));}},getDebugStr:function(obj){return Object.toJSON(obj).replace('&','&amp;').replace('>','&gt;').replace('<','&lt;');},getFileVars:function(file){return{id:this.getFileId(file),fileId:file.id,name:file.name,size:this.formatSize(file.size)};},getFileProgressVars:function(file){return{total:this.formatSize(file.progress.total),uploaded:this.formatSize(file.progress.loaded),percent:this.round((file.progress.loaded/file.progress.total)*100)};},formatSize:function(size){if(size>1024*1024*1024*1024){return this.round(size/(1024*1024*1024*1024))+' '+this.translate('TB');}else if(size>1024*1024*1024){return this.round(size/(1024*1024*1024))+' '+this.translate('GB');}else if(size>1024*1024){return this.round(size/(1024*1024))+' '+this.translate('MB');}else if(size>1024){return this.round(size/(1024))+' '+this.translate('kB');}
return size+' '+this.translate('B');},round:function(number){return Math.round(number*100)/100;},checkFileSize:function(){newFiles=[];hasTooBigFiles=false;this.files.each(function(file){if(file.size>maxUploadFileSizeInBytes){hasTooBigFiles=true;this.uploader.removeFile(file.id)}else{newFiles.push(file)}}.bind(this));this.files=newFiles;if(hasTooBigFiles){alert(this.translate('Maximum allowed file size for upload is')+' '+maxUploadFileSize+".\n"+this.translate('Please check your server PHP settings.'));}},translate:function(text){try{if(Translator){return Translator.translate(text);}}
catch(e){}
return text;},errorText:function(file){var error='';switch(file.errorCode){case 1:error='File size should be more than 0 bytes';break;case 2:error='Upload HTTP Error';break;case 3:error='Upload I/O Error';break;case 4:error='Upload Security Error';break;case 5:error='SSL Error: Invalid or self-signed certificate';break;}
if(error){return this.translate(error);}
return error;},handleContainerHideBefore:function(container){if(container&&Element.descendantOf(this.container,container)&&!this.checkAllComplete()){if(!confirm('There are files that were selected but not uploaded yet. After switching to another tab your selections will be lost. Do you wish to continue ?')){return'cannotchange';}else{this.removeAllFiles();}}},checkAllComplete:function(){if(this.files){return!this.files.any(function(file){return(file.status!=='full_complete')});}
return true;}}};MediabrowserUtility={openDialog:function(url,width,height,title){if($('browser_window')&&typeof(Windows)!='undefined'){Windows.focus('browser_window');return;}
this.dialogWindow=Dialog.info(null,{closable:true,resizable:false,draggable:true,className:'magento',windowClassName:'popup-window',title:title||'Insert File...',top:50,width:width||950,height:height||600,zIndex:1000,recenterAuto:false,hideEffect:Element.hide,showEffect:Element.show,id:'browser_window',onClose:this.closeDialog.bind(this)});new Ajax.Updater('modal_dialog_message',url,{evalScripts:true});},closeDialog:function(window){if(!window){window=this.dialogWindow;}
if(window){WindowUtilities._showSelect();window.close();}}};Mediabrowser=Class.create();Mediabrowser.prototype={targetElementId:null,contentsUrl:null,onInsertUrl:null,newFolderUrl:null,deleteFolderUrl:null,deleteFilesUrl:null,headerText:null,tree:null,currentNode:null,storeId:null,initialize:function(setup){this.newFolderPrompt=setup.newFolderPrompt;this.deleteFolderConfirmationMessage=setup.deleteFolderConfirmationMessage;this.deleteFileConfirmationMessage=setup.deleteFileConfirmationMessage;this.targetElementId=setup.targetElementId;this.contentsUrl=setup.contentsUrl;this.onInsertUrl=setup.onInsertUrl;this.newFolderUrl=setup.newFolderUrl;this.deleteFolderUrl=setup.deleteFolderUrl;this.deleteFilesUrl=setup.deleteFilesUrl;this.headerText=setup.headerText;},setTree:function(tree){this.tree=tree;this.currentNode=tree.getRootNode();},getTree:function(tree){return this.tree;},selectFolder:function(node,event){this.currentNode=node;this.hideFileButtons();this.activateBlock('contents');if(node.id=='root'){this.hideElement('button_delete_folder');}else{this.showElement('button_delete_folder');}
this.updateHeader(this.currentNode);this.drawBreadcrumbs(this.currentNode);this.showElement('loading-mask');new Ajax.Request(this.contentsUrl,{parameters:{node:this.currentNode.id},evalJS:true,onSuccess:function(transport){try{this.currentNode.select();this.onAjaxSuccess(transport);this.hideElement('loading-mask');if($('contents')!=undefined){$('contents').update(transport.responseText);$$('div.filecnt').each(function(s){Event.observe(s.id,'click',this.selectFile.bind(this));Event.observe(s.id,'dblclick',this.insert.bind(this));}.bind(this));}}catch(e){alert(e.message);}}.bind(this)});},selectFolderById:function(nodeId){var node=this.tree.getNodeById(nodeId);if(node.id){this.selectFolder(node);}},selectFile:function(event){var div=Event.findElement(event,'DIV');$$('div.filecnt.selected[id!="'+div.id+'"]').each(function(e){e.removeClassName('selected');})
div.toggleClassName('selected');if(div.hasClassName('selected')){this.showFileButtons();}else{this.hideFileButtons();}},showFileButtons:function(){this.showElement('button_delete_files');this.showElement('button_insert_files');},hideFileButtons:function(){this.hideElement('button_delete_files');this.hideElement('button_insert_files');},handleUploadComplete:function(files){$$('div[class*="file-row complete"]').each(function(e){$(e.id).remove();});this.selectFolder(this.currentNode);},insert:function(event){var div;if(event!=undefined){div=Event.findElement(event,'DIV');}else{$$('div.selected').each(function(e){div=$(e.id);});}
if($(div.id)==undefined){return false;}
var targetEl=this.getTargetElement();if(!targetEl){alert("Target element not found for content update");Windows.close('browser_window');return;}
var params={filename:div.id,node:this.currentNode.id,store:this.storeId};if(targetEl.tagName.toLowerCase()=='textarea'){params.as_is=1;}
new Ajax.Request(this.onInsertUrl,{parameters:params,onSuccess:function(transport){try{this.onAjaxSuccess(transport);if(this.getMediaBrowserOpener()){self.blur();}
Windows.close('browser_window');if(targetEl.tagName.toLowerCase()=='input'){targetEl.value=transport.responseText;}else{updateElementAtCursor(targetEl,transport.responseText);if(varienGlobalEvents){varienGlobalEvents.fireEvent('tinymceChange');}}}catch(e){alert(e.message);}}.bind(this)});},getTargetElement:function(){if(typeof(tinyMCE)!='undefined'&&tinyMCE.get(this.targetElementId)){if((opener=this.getMediaBrowserOpener())){var targetElementId=tinyMceEditors.get(this.targetElementId).getMediaBrowserTargetElementId();return opener.document.getElementById(targetElementId);}else{return null;}}else{return document.getElementById(this.targetElementId);}},getMediaBrowserOpener:function(){if(typeof(tinyMCE)!='undefined'&&tinyMCE.get(this.targetElementId)&&typeof(tinyMceEditors)!='undefined'&&!tinyMceEditors.get(this.targetElementId).getMediaBrowserOpener().closed){return tinyMceEditors.get(this.targetElementId).getMediaBrowserOpener();}else{return null;}},newFolder:function(){var folderName=prompt(this.newFolderPrompt);if(!folderName){return false;}
new Ajax.Request(this.newFolderUrl,{parameters:{name:folderName},onSuccess:function(transport){try{this.onAjaxSuccess(transport);if(transport.responseText.isJSON()){var response=transport.responseText.evalJSON()
var newNode=new Ext.tree.AsyncTreeNode({text:response.short_name,draggable:false,id:response.id,expanded:true});var child=this.currentNode.appendChild(newNode);this.tree.expandPath(child.getPath(),'',function(success,node){this.selectFolder(node);}.bind(this));}}catch(e){alert(e.message);}}.bind(this)})},deleteFolder:function(){if(!confirm(this.deleteFolderConfirmationMessage)){return false;}
new Ajax.Request(this.deleteFolderUrl,{onSuccess:function(transport){try{this.onAjaxSuccess(transport);var parent=this.currentNode.parentNode;parent.removeChild(this.currentNode);this.selectFolder(parent);}
catch(e){alert(e.message);}}.bind(this)})},deleteFiles:function(){if(!confirm(this.deleteFileConfirmationMessage)){return false;}
var ids=[];var i=0;$$('div.selected').each(function(e){ids[i]=e.id;i++;});new Ajax.Request(this.deleteFilesUrl,{parameters:{files:Object.toJSON(ids)},onSuccess:function(transport){try{this.onAjaxSuccess(transport);this.selectFolder(this.currentNode);}catch(e){alert(e.message);}}.bind(this)});},drawBreadcrumbs:function(node){if($('breadcrumbs')!=undefined){$('breadcrumbs').remove();}
if(node.id=='root'){return;}
var path=node.getPath().split('/');var breadcrumbs='';for(var i=0,length=path.length;i<length;i++){if(path[i]==''){continue;}
var currNode=this.tree.getNodeById(path[i]);if(currNode.id){breadcrumbs+='<li>';breadcrumbs+='<a href="#" onclick="MediabrowserInstance.selectFolderById(\''+currNode.id+'\');">'+currNode.text+'</a>';if(i<(length-1)){breadcrumbs+=' <span>/</span>';}
breadcrumbs+='</li>';}}
if(breadcrumbs!=''){breadcrumbs='<ul class="breadcrumbs" id="breadcrumbs">'+breadcrumbs+'</ul>';$('content_header').insert({after:breadcrumbs});}},updateHeader:function(node){var header=(node.id=='root'?this.headerText:node.text);if($('content_header_text')!=undefined){$('content_header_text').innerHTML=header;}},activateBlock:function(id){this.showElement(id);},hideElement:function(id){if($(id)!=undefined){$(id).addClassName('no-display');$(id).hide();}},showElement:function(id){if($(id)!=undefined){$(id).removeClassName('no-display');$(id).show();}},onAjaxSuccess:function(transport){if(transport.responseText.isJSON()){var response=transport.responseText.evalJSON()
if(response.error){throw response;}else if(response.ajaxExpired&&response.ajaxRedirect){setLocation(response.ajaxRedirect);}}}};function onUseImageProductClick(checked_ch){$$("[rel=use_image_from_product]").each(function(ch){if(ch.id.indexOf('__id__')===-1){if(checked_ch.checked&&ch!=checked_ch)
ch.checked=false;if(superProduct&&typeof(superProduct.attributes)=='object'){for(var indProd in superProduct.attributes){var attributes=superProduct.attributes[indProd];if(typeof(attributes)=='object'){if(ch.id.indexOf(attributes.html_id)!==-1){attributes.use_image_from_product=ch.checked?"1":"0";}}}
superProduct.updateSaveInput();}}});}
function checkUseImageProducts(ids){if(superProduct&&typeof(superProduct.attributes)=='object'){for(var indIds in ids){var id=ids[indIds];if(typeof(id)!=='function'){for(var ind in superProduct.attributes){var attribute=superProduct.attributes[ind];if(attribute.id==id){$('configurable__attribute_'+ind+'_use_image_from_product').checked=true;attribute.use_image_from_product=true;}}}}
superProduct.updateSaveInput();}}